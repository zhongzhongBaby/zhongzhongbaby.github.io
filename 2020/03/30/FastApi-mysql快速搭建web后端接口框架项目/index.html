<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style-dark.css?v=2.0.4"><link rel="stylesheet" type="text/css" href="/css/highlight-dark.css?v=2.0.4"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><title>FastApi+mysql快速搭建web后端接口框架项目 | zhongzhongBaby</title></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">FastApi+mysql快速搭建web后端接口框架项目</h1><a id="logo" href="/.">zhongzhongBaby</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="search"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">FastApi+mysql快速搭建web后端接口框架项目</h1><div class="post-meta"><a href="/2020/03/30/FastApi-mysql快速搭建web后端接口框架项目/#comments" class="comment-count"></a><p><span class="date">Mar 30, 2020</span><span><a href="/categories/web框架/" class="category">web框架</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Hits</i></i></span></p></div><div class="post-content"><h1 id="FastApi-mysql-快速搭建web后端接口框架"><a href="#FastApi-mysql-快速搭建web后端接口框架" class="headerlink" title="FastApi+mysql 快速搭建web后端接口框架"></a>FastApi+mysql 快速搭建web后端接口框架</h1><h2 id="项目地址："><a href="#项目地址：" class="headerlink" title="项目地址："></a>项目地址：</h2><p><a href="https://github.com/zhongzhongBaby/FastapiMysqlDemo" target="_blank" rel="noopener">https://github.com/zhongzhongBaby/FastapiMysqlDemo</a></p>
<h2 id="项目描述："><a href="#项目描述：" class="headerlink" title="项目描述："></a>项目描述：</h2><p>最近从java转来学习FastApi，想要快速搭建一个FastApi+mysql的后端接口框架，但是网上没有找到demo，所以自己简单写了一个，做了一些简单的封装，希望对和我一样的新学者有所帮助。<br></p>
<h2 id="功能涵盖："><a href="#功能涵盖：" class="headerlink" title="功能涵盖："></a>功能涵盖：</h2><p>1.使用数据源访问mysql<br><br>2.实现中文api文档<br><br>3.请求参数数据验证<br><br>4.使用jwt实现Token登录验证<br><br>5.不同环境（生产、测试），配置环境参数<br></p>
<h3 id="1-数据源访问工具类"><a href="#1-数据源访问工具类" class="headerlink" title="1.数据源访问工具类"></a>1.数据源访问工具类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">import pymysql</span><br><span class="line">from DBUtils.PooledDB import PooledDB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MySQLHelper(object):</span><br><span class="line">    def __init__(self, host, port, dbuser, password, database):</span><br><span class="line">        self.pool = PooledDB(</span><br><span class="line">            creator=pymysql,  # 使用链接数据库的模块</span><br><span class="line">            maxconnections=6,  # 连接池允许的最大连接数，0和None表示不限制连接数</span><br><span class="line">            mincached=2,  # 初始化时，链接池中至少创建的空闲的链接，0表示不创建</span><br><span class="line">            maxcached=5,  # 链接池中最多闲置的链接，0和None不限制</span><br><span class="line">            maxshared=3,</span><br><span class="line">            # 链接池中最多共享的链接数量，0和None表示全部共享。PS: 无用，因为pymysql和MySQLdb等模块的 threadsafety都为1，所有值无论设置为多少，_maxcached永远为0，所以永远是所有链接都共享。</span><br><span class="line">            blocking=True,  # 连接池中如果没有可用连接后，是否阻塞等待。True，等待；False，不等待然后报错</span><br><span class="line">            maxusage=None,  # 一个链接最多被重复使用的次数，None表示无限制</span><br><span class="line">            setsession=[],  # 开始会话前执行的命令列表。如：[&quot;set datestyle to ...&quot;, &quot;set time zone ...&quot;]</span><br><span class="line">            ping=0,</span><br><span class="line">            # ping MySQL服务端，检查是否服务可用。# 如：0 = None = never, 1 = default = whenever it is requested, 2 = when a cursor is created, 4 = when a query is executed, 7 = always</span><br><span class="line">            host=host,</span><br><span class="line">            port=int(port),</span><br><span class="line">            user=dbuser,</span><br><span class="line">            password=password,</span><br><span class="line">            database=database,</span><br><span class="line">            charset=&apos;utf8&apos;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    def create_conn_cursor(self):</span><br><span class="line">        conn = self.pool.connection()</span><br><span class="line">        cursor = conn.cursor(pymysql.cursors.DictCursor)</span><br><span class="line">        return conn, cursor</span><br><span class="line"></span><br><span class="line">    def fetch_one(self, sql):</span><br><span class="line">        conn, cursor = self.create_conn_cursor()</span><br><span class="line">        cursor.execute(sql)</span><br><span class="line">        result = cursor.fetchone()</span><br><span class="line">        cursor.close()</span><br><span class="line">        conn.close()</span><br><span class="line">        return result</span><br><span class="line"></span><br><span class="line">    def fetch_all(self, sql, args):</span><br><span class="line">        conn, cursor = self.create_conn_cursor()</span><br><span class="line">        cursor.execute(sql, args)</span><br><span class="line">        result = cursor.fetchall()</span><br><span class="line">        cursor.close()</span><br><span class="line">        conn.close()</span><br><span class="line">        return result</span><br><span class="line"></span><br><span class="line">    def fetch_all2(self, sql):</span><br><span class="line">        conn, cursor = self.create_conn_cursor()</span><br><span class="line">        cursor.execute(sql)</span><br><span class="line">        result = cursor.fetchall()</span><br><span class="line">        cursor.close()</span><br><span class="line">        conn.close()</span><br><span class="line">        return result</span><br><span class="line"></span><br><span class="line">    def insert_one(self, sql, args):</span><br><span class="line">        conn, cursor = self.create_conn_cursor()</span><br><span class="line">        res = cursor.execute(sql, args)</span><br><span class="line">        conn.commit()</span><br><span class="line">        print(res)</span><br><span class="line">        conn.close()</span><br><span class="line">        return res</span><br><span class="line"></span><br><span class="line">    def update(self, sql, args):</span><br><span class="line">        conn, cursor = self.create_conn_cursor()</span><br><span class="line">        res = cursor.execute(sql, args)</span><br><span class="line">        conn.commit()</span><br><span class="line">        print(res)</span><br><span class="line">        conn.close()</span><br><span class="line">        return res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sql_helper = MySQLHelper(&quot;127.0.0.1&quot;, 3306, &quot;root&quot;, &quot;123456&quot;, &quot;demo&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="2-api文档实现效果"><a href="#2-api文档实现效果" class="headerlink" title="2.api文档实现效果"></a>2.api文档实现效果</h3><p><img src="https://note.youdao.com/yws/api/personal/file/39E175C1C29846E5AE92B1A8D222EA95?method=download&shareKey=428a760f737abeffd2b59b357ede0c35" alt="image"></p>
<h3 id="3-请求参数数据验证"><a href="#3-请求参数数据验证" class="headerlink" title="3.请求参数数据验证"></a>3.请求参数数据验证</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//使用pydantic.Field方法数据验证</span><br><span class="line">class FindCourseListRequest(FindRequestBase):</span><br><span class="line">    course_id: str = Field(None, title=&quot;课程id&quot;, max_length=300)</span><br><span class="line">    name: str = Field(None, title=&quot;名称&quot;, max_length=300)</span><br><span class="line">    subject: str = Field(..., title=&quot;科目&quot;, max_length=300)</span><br></pre></td></tr></table></figure>

<p>以上是对参数的基本校验，如：参数类型，是否必传，参数长度等。<br>如果需要进行更多自定义的校验可以使用pydantic.@validator。</p>
<h3 id="4-使用jwt实现Token登录验证"><a href="#4-使用jwt实现Token登录验证" class="headerlink" title="4.使用jwt实现Token登录验证"></a>4.使用jwt实现Token登录验证</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">from datetime import datetime, timedelta</span><br><span class="line">import jwt</span><br><span class="line">from fastapi import Depends, HTTPException, status</span><br><span class="line">from fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm</span><br><span class="line">from jwt import *</span><br><span class="line">from passlib.context import CryptContext</span><br><span class="line">from pydantic import BaseModel</span><br><span class="line">from utils.mysql_utils import sql_helper</span><br><span class="line">from fastapi import APIRouter</span><br><span class="line">from pydantic import Field</span><br><span class="line"></span><br><span class="line">login_router = APIRouter()</span><br><span class="line"></span><br><span class="line"># to get a string like this run:</span><br><span class="line"># openssl rand -hex 32</span><br><span class="line">SECRET_KEY = &quot;09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7&quot;</span><br><span class="line">ALGORITHM = &quot;HS256&quot;</span><br><span class="line">ACCESS_TOKEN_EXPIRE_MINUTES = 60 * 24  # 会话超时时间 默认1天</span><br><span class="line"></span><br><span class="line"># 系统默认的登录用户,如果不去数据库进行验证用户信息，可在这儿配置</span><br><span class="line">fake_users_db = &#123;</span><br><span class="line">    &quot;pxxAdmin&quot;: &#123;</span><br><span class="line">        &quot;username&quot;: &quot;pxxAdmin&quot;,</span><br><span class="line">        &quot;hashed_password&quot;: &quot;$2b$12$Y26vyX0FkZHBq3T57GzdwOd4WxJDoHV0PckspBfKbZ4LkDPOc1A4y&quot;,</span><br><span class="line">        &quot;disabled&quot;: False,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Token(BaseModel):</span><br><span class="line">    user_name: str = Field(None, description=&quot;token 类型&quot;)</span><br><span class="line">    access_token: str = Field(..., description=&quot;访问token密文，其他接口访问时在header上加参数（Authorization:密文） &quot;)</span><br><span class="line">    token_type: str = Field(..., description=&quot;token 类型&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class TokenData(BaseModel):</span><br><span class="line">    username: str = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class User(BaseModel):</span><br><span class="line">    username: str</span><br><span class="line">    disabled: bool = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UserInDB(User):</span><br><span class="line">    hashed_password: str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwd_context = CryptContext(schemes=[&quot;bcrypt&quot;], deprecated=&quot;auto&quot;)</span><br><span class="line"></span><br><span class="line">oauth2_scheme = OAuth2PasswordBearer(tokenUrl=&quot;/login&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def verify_password(plain_password, hashed_password):</span><br><span class="line">    return pwd_context.verify(plain_password, hashed_password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_password_hash(password):</span><br><span class="line">    return pwd_context.hash(password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_user(db, username: str):</span><br><span class="line">    user_dict = get_user_from_db(username)</span><br><span class="line">    if user_dict is not None:</span><br><span class="line">        return UserInDB(**user_dict)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def authenticate_user(fake_db, username: str, password: str):</span><br><span class="line">    user = get_user(fake_db, username)</span><br><span class="line">    if not user:</span><br><span class="line">        return False</span><br><span class="line">    if not verify_password(password, user.hashed_password):</span><br><span class="line">        return False</span><br><span class="line">    return user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def create_access_token(*, data: dict, expires_delta: timedelta = None):</span><br><span class="line">    to_encode = data.copy()</span><br><span class="line">    if expires_delta:</span><br><span class="line">        expire = datetime.utcnow() + expires_delta</span><br><span class="line">    else:</span><br><span class="line">        expire = datetime.utcnow() + timedelta(minutes=15)</span><br><span class="line">    to_encode.update(&#123;&quot;exp&quot;: expire&#125;)</span><br><span class="line">    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)</span><br><span class="line">    return encoded_jwt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async def get_current_user(token: str = Depends(oauth2_scheme)):</span><br><span class="line">    credentials_exception = HTTPException(</span><br><span class="line">        status_code=status.HTTP_401_UNAUTHORIZED,</span><br><span class="line">        detail=&quot;Could not validate credentials&quot;,</span><br><span class="line">        headers=&#123;&quot;WWW-Authenticate&quot;: &quot;Bearer&quot;&#125;,</span><br><span class="line">    )</span><br><span class="line">    try:</span><br><span class="line">        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])</span><br><span class="line">        username: str = payload.get(&quot;sub&quot;)</span><br><span class="line">        if username is None:</span><br><span class="line">            raise credentials_exception</span><br><span class="line">        token_data = TokenData(username=username)</span><br><span class="line">    except PyJWTError:</span><br><span class="line">        raise credentials_exception</span><br><span class="line">    user = get_user(fake_users_db, username=token_data.username)</span><br><span class="line">    if user is None:</span><br><span class="line">        raise credentials_exception</span><br><span class="line">    return user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async def get_current_active_user(current_user: User = Depends(get_current_user)):</span><br><span class="line">    if current_user.disabled:</span><br><span class="line">        raise HTTPException(status_code=400, detail=&quot;Inactive user&quot;)</span><br><span class="line">    return current_user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@login_router.post(&quot;/login&quot;, response_model=Token, summary=&quot;登录接口&quot;)</span><br><span class="line">async def login_for_access_token(form_data: OAuth2PasswordRequestForm = Depends()):</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    默认账号  密码  pxxAdmin   123456</span><br><span class="line"></span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    user = authenticate_user(fake_users_db, form_data.username, form_data.password)</span><br><span class="line">    if not user:</span><br><span class="line">        raise HTTPException(</span><br><span class="line">            status_code=status.HTTP_401_UNAUTHORIZED,</span><br><span class="line">            detail=&quot;Incorrect username or password&quot;,</span><br><span class="line">            headers=&#123;&quot;WWW-Authenticate&quot;: &quot;Bearer&quot;&#125;,</span><br><span class="line">        )</span><br><span class="line">    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)</span><br><span class="line">    access_token = create_access_token(</span><br><span class="line">        data=&#123;&quot;sub&quot;: user.username&#125;, expires_delta=access_token_expires</span><br><span class="line">    )</span><br><span class="line">    return &#123;&quot;user_name&quot;: user.username, &quot;access_token&quot;: &quot;Bearer &quot; + str(access_token, encoding=&quot;utf8&quot;),</span><br><span class="line">            &quot;token_type&quot;: &quot;bearer2&quot;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 从数据库获取用户信息</span><br><span class="line">def get_user_from_db(username):</span><br><span class="line">    sql = &quot;SELECT username,hashed_password, disabled FROM  sys_user where username = &apos;%s&apos; &quot; % username</span><br><span class="line">    user = sql_helper.fetch_one(sql)</span><br><span class="line">    return user</span><br></pre></td></tr></table></figure>

<p>访问login接口，登录成功，可以<strong>返回token密文</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;user_name&quot;: &quot;Admin&quot;,</span><br><span class="line">    &quot;access_token&quot;: &quot;Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJBZG1pbiIsImV4cCI6MTU4NzgwNTcxMH0.qwahQ22GaMGOpoE_xHr_Dg-i8VjO1bwEl2uJSz1ry6U&quot;,</span><br><span class="line">    &quot;token_type&quot;: &quot;bearer2&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后在<strong>访问其他需要登录验证的接口</strong>的时候，只需要在接口请求header上添加token密文参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization ：Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJBZG1pbiIsImV4cCI6MTU4NzgwNTcxMH0.qwahQ22GaMGOpoE_xHr_Dg-i8VjO1bwEl2uJSz1ry6U</span><br></pre></td></tr></table></figure>

<p><strong>设置接口登录验证</strong>只需要在接口方法上添加参数：<br><br>current_user: User = Depends(get_current_active_user)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">async def find_course_selective(current_user: User = Depends(get_current_active_user),</span><br><span class="line">                                request: FindCourseListRequest = Body(None, title=&quot;课程筛选条件&quot;)):</span><br></pre></td></tr></table></figure>

<h3 id="5-不同环境（生产、测试），配置环境参数"><a href="#5-不同环境（生产、测试），配置环境参数" class="headerlink" title="5.不同环境（生产、测试），配置环境参数"></a>5.不同环境（生产、测试），配置环境参数</h3><p>新建几个环境参数文件：prod.env,test.env</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">from pydantic import BaseSettings</span><br><span class="line">from functools import lru_cache</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@lru_cache()</span><br><span class="line">def get_settings():</span><br><span class="line">    return Settings(_env_file=&apos;prod.env&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Settings(BaseSettings):</span><br><span class="line">    app_name: str = &quot;FastApiMysqlDemo&quot;</span><br><span class="line">    admin_email: str = &quot;844383583@qq.com&quot;</span><br><span class="line">    database: dict = &#123;</span><br><span class="line">        &quot;url&quot;: &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;port&quot;: 3306,</span><br><span class="line">        &quot;user&quot;: &quot;root&quot;,</span><br><span class="line">        &quot;password&quot;: &quot;12346&quot;,</span><br><span class="line">        &quot;database_name&quot;: &quot;demo&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class Config:</span><br><span class="line">        env_file = &quot;prod.env&quot;</span><br></pre></td></tr></table></figure>

<p><strong>@lru_cache()目的</strong>：因为环境参数要从文件中读取，这样存于内存可以避免IO次数。<br><strong>使用：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import config</span><br><span class="line">database = config.get_settings().database</span><br><span class="line"></span><br><span class="line">sql_helper = MySQLHelper(database[&quot;url&quot;], database[&quot;port&quot;],</span><br><span class="line">                         database[&quot;user&quot;], database[&quot;password&quot;], database[&quot;database_name&quot;])</span><br></pre></td></tr></table></figure>

<h2 id="项目启动"><a href="#项目启动" class="headerlink" title="项目启动"></a>项目启动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- 项目启动</span><br><span class="line"></span><br><span class="line">        uvicorn main:app --reload</span><br><span class="line">        # 指定端口和主机</span><br><span class="line">        uvicorn main:app --reload  --port 8000 --host 192.168.1.24</span><br></pre></td></tr></table></figure>

</div><div class="post-copyright"><blockquote><p>Original author: Geng</p><p>Original link: <a href="https://zhongzhongbaby.github.io/2020/03/30/FastApi-mysql快速搭建web后端接口框架项目/">https://zhongzhongbaby.github.io/2020/03/30/FastApi-mysql快速搭建web后端接口框架项目/</a></p><p>Copyright Notice: Please indicate the source of the reprint (must retain the author's signature and link)</p></blockquote></div><div class="tags"><a href="/tags/FastApi/">FastApi</a><a href="/tags/mysql/">mysql</a><a href="/tags/python/">python</a><a href="/tags/fastApi中文接口文档/">fastApi中文接口文档</a></div><div class="post-share"><div class="social-share"><span>Share:</span></div></div><div class="post-nav"><a href="/2020/12/30/两对公私钥解决重放攻击/" class="pre">两对公私钥解决重放攻击</a><a href="/2020/01/01/java-正则表达式（实现正则匹配）/" class="next">java + 正则表达式（实现正则匹配）</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Contents</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#FastApi-mysql-快速搭建web后端接口框架"><span class="toc-text">FastApi+mysql 快速搭建web后端接口框架</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#项目地址："><span class="toc-text">项目地址：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目描述："><span class="toc-text">项目描述：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#功能涵盖："><span class="toc-text">功能涵盖：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-数据源访问工具类"><span class="toc-text">1.数据源访问工具类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-api文档实现效果"><span class="toc-text">2.api文档实现效果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-请求参数数据验证"><span class="toc-text">3.请求参数数据验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-使用jwt实现Token登录验证"><span class="toc-text">4.使用jwt实现Token登录验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-不同环境（生产、测试），配置环境参数"><span class="toc-text">5.不同环境（生产、测试），配置环境参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目启动"><span class="toc-text">项目启动</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/12/30/两对公私钥解决重放攻击/">两对公私钥解决重放攻击</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/30/FastApi-mysql快速搭建web后端接口框架项目/">FastApi+mysql快速搭建web后端接口框架项目</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/01/java-正则表达式（实现正则匹配）/">java + 正则表达式（实现正则匹配）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/23/RabiitMQ学习笔记/">RabiitMQ学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/26/idea使用技巧/">idea使用技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/14/nginx-简单配置和常见问题总结（持续总结/">nginx 简单配置和常见问题总结（持续总结....)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/29/mysql组内取前/">mysql组内取前</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/28/mysql基础总结/">mysql基础总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/15/考研忆/">考研忆</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/12/博客介绍/">博客介绍</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web框架/">web框架</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器/">服务器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/正则表达式/">正则表达式</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/经历感悟/">经历感悟</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"><a href="/tags/idea/" style="font-size: 15px;">idea</a> <a href="/tags/FastApi/" style="font-size: 15px;">FastApi</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/fastApi中文接口文档/" style="font-size: 15px;">fastApi中文接口文档</a> <a href="/tags/rabbitMQ/" style="font-size: 15px;">rabbitMQ</a> <a href="/tags/消息队列/" style="font-size: 15px;">消息队列</a> <a href="/tags/正则表达式）/" style="font-size: 15px;">正则表达式）</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/token认证，重放攻击/" style="font-size: 15px;">token认证，重放攻击</a> <a href="/tags/介绍/" style="font-size: 15px;">介绍</a> <a href="/tags/考研/" style="font-size: 15px;">考研</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archive</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Site Map</a> |  <a href="/atom.xml">Subscribe to this site</a> |  <a href="/about/">Contact the blogger</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">Geng.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.4"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.4" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>